<Project>
  <PropertyGroup>
    <!-- Determine the runtime pack name based on whether we're using Mono or CoreCLR.
         UseMonoRuntime is set by Microsoft.NET.Sdk.WebAssembly; when not set (CoreCLR), omit the Mono. prefix. -->
    <_WasmRuntimePackPrefix Condition="'$(UseMonoRuntime)' != 'false'">Mono.</_WasmRuntimePackPrefix>
    <_WasmRuntimePackPrefix Condition="'$(UseMonoRuntime)' == 'false'"></_WasmRuntimePackPrefix>
    <_WasmRuntimePackName>Microsoft.NETCore.App.Runtime.$(_WasmRuntimePackPrefix)$(RuntimeIdentifier)</_WasmRuntimePackName>
  </PropertyGroup>

  <!-- SDK tries to download runtime packs when RuntimeIdentifier is set, remove them from PackageDownload item. -->
  <Target Name="RemoveRuntimePackFromDownloadItem"
          AfterTargets="ProcessFrameworkReferences">
    <ItemGroup>
      <PackageDownload Remove="@(PackageDownload)"
                       Condition="'$(UsePackageDownload)' == 'true' and $([System.String]::Copy('%(Identity)').StartsWith('Microsoft.NETCore.App.Runtime'))" />
      <PackageReference Remove="@(PackageReference)"
                        Condition="'$(UsePackageDownload)' != 'true' and $([System.String]::Copy('%(Identity)').StartsWith('Microsoft.NETCore.App.Runtime'))" />
    </ItemGroup>
  </Target>

  <!-- Use local targeting pack for NetCoreAppCurrent. -->
  <Target Name="UpdateTargetingAndRuntimePack"
          AfterTargets="ResolveFrameworkReferences">
    <ItemGroup>
      <ResolvedRuntimePack
          FrameworkName="Microsoft.NETCore.App"
          NuGetPackageId="$(_WasmRuntimePackName)"
          NuGetPackageVersion="$(_RuntimePackInWorkloadVersionCurrent)"
          PackageDirectory="$(NetCoreTargetingPackRoot)\%(Identity)\$(_RuntimePackInWorkloadVersionCurrent)"
          RuntimeIdentifier="$(RuntimeIdentifier)" />

      <ResolvedFrameworkReference
          Condition="'%(Identity)' == 'Microsoft.NETCore.App'"
          RuntimePackName="$(_WasmRuntimePackName)"
          RuntimePackVersion="$(_RuntimePackInWorkloadVersionCurrent)"
          RuntimePackPath="$(NetCoreTargetingPackRoot)\$(_WasmRuntimePackName)\$(_RuntimePackInWorkloadVersionCurrent)"
          RuntimeIdentifier="$(RuntimeIdentifier)" />
    </ItemGroup>
  </Target>

  <!-- Update the local targeting pack's version as it's written into the runtimeconfig.json file to select the right framework. -->
  <Target Name="UpdateRuntimeFrameworkVersion"
          AfterTargets="ResolveTargetingPackAssets">
    <ItemGroup>
      <RuntimeFramework Version="$(_RuntimePackInWorkloadVersionCurrent)"
                        Condition="'%(RuntimeFramework.FrameworkName)' == 'Microsoft.NETCore.App'" />
    </ItemGroup>
  </Target>

  <!-- Filter out conflicting implicit assembly references. -->
  <Target Name="FilterImplicitAssemblyReferences"
          DependsOnTargets="ResolveProjectReferences"
          AfterTargets="ResolveTargetingPackAssets">
    <ItemGroup>
      <_targetingPackReferenceExclusion Include="$(TargetName)" />
      <_targetingPackReferenceExclusion Include="@(_ResolvedProjectReferencePaths->'%(Filename)')" />
      <_targetingPackReferenceExclusion Include="@(DefaultReferenceExclusion)" />
    </ItemGroup>

    <ItemGroup>
      <_targetingPackReferenceWithExclusion Include="@(Reference)">
        <Exclusion>%(_targetingPackReferenceExclusion.Identity)</Exclusion>
      </_targetingPackReferenceWithExclusion>
      <Reference Remove="@(_targetingPackReferenceWithExclusion)"
                 Condition="'%(_targetingPackReferenceWithExclusion.ExternallyResolved)' == 'true' and '%(_targetingPackReferenceWithExclusion.Filename)' == '%(_targetingPackReferenceWithExclusion.Exclusion)'" />
    </ItemGroup>
  </Target>

  <ItemGroup>
    <KnownWebAssemblySdkPack Update="Microsoft.NET.Sdk.WebAssembly.Pack"
      WebAssemblySdkPackVersion="$(_RuntimePackInWorkloadVersionCurrent)" />
  </ItemGroup>
</Project>
